import 'package:flutter/material.dart';

void main() => runApp(const LibraryApp());

// --- Models ---
class Book {
  String title, author, genre;
  int copies;
  Book(this.title, this.author, this.genre, this.copies);
}

class BorrowRecord {
  String student, book;
  DateTime returnDate;
  BorrowRecord(this.student, this.book, this.returnDate);
}

// --- Main App ---
class LibraryApp extends StatelessWidget {
  const LibraryApp({super.key});
  @override
  Widget build(BuildContext context) => MaterialApp(
        debugShowCheckedModeBanner: false,
        title: 'Library',
        theme: ThemeData(useMaterial3: true, colorSchemeSeed: Colors.indigo),
        home: const LibraryHome(),
      );
}

class LibraryHome extends StatefulWidget {
  const LibraryHome({super.key});
  @override
  State<LibraryHome> createState() => _LibraryHomeState();
}

class _LibraryHomeState extends State<LibraryHome> {
  // Data
  final List<Book> _books = [
    Book("Great Gatsby", "Fitzgerald", "Classic", 3),
    Book("1984", "Orwell", "Sci-Fi", 0),
    Book("Harry Potter", "Rowling", "Fantasy", 2),
    Book("Clean Code", "Robert Martin", "Education", 1),
  ];
  final List<BorrowRecord> _loans = [];
  String _genreFilter = "All";

  // Helpers
  List<String> get _genres => ["All", ..._books.map((b) => b.genre).toSet()];
  List<Book> get _filtered => _genreFilter == "All" 
      ? _books 
      : _books.where((b) => b.genre == _genreFilter).toList();

  // --- Actions ---
  
  void _addBook() {
    String t = '', a = '', g = 'General';
    int c = 1;
    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: const Text("Add New Book"),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(decoration: const InputDecoration(labelText: "Title"), onChanged: (v) => t = v),
            TextField(decoration: const InputDecoration(labelText: "Author"), onChanged: (v) => a = v),
            TextField(decoration: const InputDecoration(labelText: "Genre"), onChanged: (v) => g = v),
            TextField(decoration: const InputDecoration(labelText: "Copies"), keyboardType: TextInputType.number, onChanged: (v) => c = int.tryParse(v) ?? 1),
          ],
        ),
        actions: [
          TextButton(onPressed: () => Navigator.pop(context), child: const Text("Cancel")),
          ElevatedButton(
            onPressed: () {
              if (t.isNotEmpty && a.isNotEmpty) {
                setState(() => _books.add(Book(t, a, g, c)));
                Navigator.pop(context);
              }
            },
            child: const Text("Add"),
          )
        ],
      ),
    );
  }

  void _issueBook(Book book) {
    String student = '';
    int selectedDays = 7; // Store integer directly to avoid rounding errors

    showDialog(
      context: context,
      builder: (context) {
        // StatefulBuilder is needed to update the dropdown INSIDE the dialog
        return StatefulBuilder(
          builder: (context, setStateDialog) {
            return AlertDialog(
              title: Text("Issue '${book.title}'"),
              content: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  TextField(
                    decoration: const InputDecoration(labelText: "Student Name"),
                    onChanged: (v) => student = v,
                  ),
                  const SizedBox(height: 10),
                  Row(
                    children: [
                      const Text("Return in: "),
                      const SizedBox(width: 10),
                      DropdownButton<int>(
                        value: selectedDays,
                        items: [3, 7, 14, 30]
                            .map((d) => DropdownMenuItem(value: d, child: Text("$d Days")))
                            .toList(),
                        onChanged: (v) {
                          setStateDialog(() { // Updates the Dialog state
                            selectedDays = v!;
                          });
                        },
                      ),
                    ],
                  )
                ],
              ),
              actions: [
                TextButton(
                  onPressed: () => Navigator.pop(context),
                  child: const Text("Cancel"),
                ),
                ElevatedButton(
                  onPressed: () {
                    if (student.isNotEmpty) {
                      // Update the main app state
                      this.setState(() {
                        book.copies--;
                        _loans.add(BorrowRecord(
                          student, 
                          book.title, 
                          DateTime.now().add(Duration(days: selectedDays)),
                        ));
                      });
                      Navigator.pop(context);
                    }
                  },
                  child: const Text("Issue"),
                )
              ],
            );
          },
        );
      },
    );
  }

  // --- UI ---
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Library Manager'), centerTitle: true, backgroundColor: Colors.indigo.shade50),
      floatingActionButton: FloatingActionButton.extended(
        onPressed: _addBook, 
        icon: const Icon(Icons.add), 
        label: const Text("Add Book"),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Stats
            Row(
              children: [
                _statCard("Total Books", _books.length.toString(), Colors.blue),
                const SizedBox(width: 10),
                _statCard("Active Loans", _loans.length.toString(), Colors.orange),
              ],
            ),
            const SizedBox(height: 20),

            // Active Loans List
            const Text("Issued Books", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
            if (_loans.isEmpty) const Text("No books currently issued.", style: TextStyle(color: Colors.grey, fontStyle: FontStyle.italic)),
            ..._loans.map((l) => Card(
              child: ListTile(
                dense: true,
                leading: const Icon(Icons.person, color: Colors.indigo),
                title: Text(l.book, style: const TextStyle(fontWeight: FontWeight.bold)),
                subtitle: Text("To: ${l.student}"),
                trailing: Text("Due: ${l.returnDate.month}/${l.returnDate.day}", style: const TextStyle(color: Colors.red, fontWeight: FontWeight.bold)),
              ),
            )),
            const SizedBox(height: 20),

            // Inventory Filter & List
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Text("Inventory", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                DropdownButton<String>(
                  value: _genreFilter,
                  underline: Container(),
                  onChanged: (v) => setState(() => _genreFilter = v!),
                  items: _genres.map((g) => DropdownMenuItem(value: g, child: Text(g))).toList(),
                ),
              ],
            ),
            const Divider(),
            ListView.builder(
              shrinkWrap: true,
              physics: const NeverScrollableScrollPhysics(),
              itemCount: _filtered.length,
              itemBuilder: (context, index) {
                final b = _filtered[index];
                return ListTile(
                  contentPadding: EdgeInsets.zero,
                  title: Text(b.title, style: const TextStyle(fontWeight: FontWeight.w600)),
                  subtitle: Text("${b.author} • ${b.genre} • ${b.copies} left"),
                  trailing: b.copies > 0
                      ? IconButton(
                          icon: const Icon(Icons.bookmark_add, color: Colors.indigo),
                          onPressed: () => _issueBook(b),
                          tooltip: "Issue Book",
                        )
                      : const Chip(label: Text("Out", style: TextStyle(fontSize: 10, color: Colors.white)), backgroundColor: Colors.grey),
                );
              },
            ),
            const SizedBox(height: 60), // Space for FAB
          ],
        ),
      ),
    );
  }

  Widget _statCard(String title, String count, Color color) => Expanded(
    child: Container(
      padding: const EdgeInsets.all(15),
      decoration: BoxDecoration(color: color.withOpacity(0.1), borderRadius: BorderRadius.circular(10)),
      child: Column(children: [
        Text(count, style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: color)),
        Text(title, style: TextStyle(color: color))
      ]),
    ),
  );
}
